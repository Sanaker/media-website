name: Deploy Next.js app

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 161.35.155.32
          username: sanaker
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/sanaker/media-website
            
            # Fix Git divergent branches by resetting to remote
            git fetch origin
            git reset --hard origin/master

            # Fix permissions to avoid build errors
            sudo chown -R sanaker:sanaker /home/sanaker/media-website 2>/dev/null || true

            echo "Checking changed files..."

            # Get the changed files from the last commit
            CHANGED_FILES=$(git diff --name-only HEAD@{1} HEAD)
            echo "$CHANGED_FILES"

            RELEVANT_PATTERNS='(\.js$|\.ts$|\.tsx$|package(-lock)?\.json|next\.config\.js|\.env)'

            if ! echo "$CHANGED_FILES" | grep -qE "$RELEVANT_PATTERNS"; then
              echo "No relevant code changes detected. Skipping build and deploy."
              exit 0
            fi

            # Fixed: Use the same CHANGED_FILES variable for consistency
            if echo "$CHANGED_FILES" | grep -qE 'package(-lock)?\.json'; then
              echo "Dependencies changed. Running npm install..."
              npm install
            else
              echo "No dependency changes. Skipping npm install."
            fi

            echo "Building the app..."
            # Disable Next.js telemetry to prevent permission issues
            NEXT_TELEMETRY_DISABLED=1 npm run build

            echo "Restarting app with supervisor"
            supervisorctl restart media-sanaker
